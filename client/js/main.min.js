function CallbackStore(){this._callbacks={}}function Emit(a){this.callbacks=new CallbackStore,this.ft=a}function Channel(a,b){this.name=a,this.subscribed=!1,this.client=b,this.connection=this.client.connection,Emit.call(this),Channel.prototype.emit=Emit.prototype.emit,Channel.prototype.bind=Emit.prototype.bind}function Channels(){this.channels={}}function Client(a,b){this.host=a,this.port=b,this.connection=new ConnectionManager(this.host,this.port),this.socket=this.connection.socket,this.channels=new Channels}function ConnectionManager(a,b){this.host=a,this.port=b,this.tries=0,this.sessionID=Math.floor(1e9*Math.random()),this.connect(this.host,this.port),this.connectionStatus="",Emit.call(this),ConnectionManager.prototype.emit=Emit.prototype.emit}CallbackStore.prototype.add=function(a,b,c){this._callbacks[a]=this._callbacks[a]||[],this._callbacks[a].push({func:b,context:c})},CallbackStore.prototype.remove=function(a){return 1==arguments.length?(delete this._callbacks[a],this):void 0},CallbackStore.prototype.get=function(a){return this._callbacks[a]};var prototype=Emit.prototype;prototype.bind=function(a,b,c){return this.callbacks.add(a,b,c),console.log(a,b,c),this},prototype.unbind=function(a,b,c){return this.callbacks.remove(a,b,c),this},prototype.emit=function(a,b){for(var c=0;c<this.callbacks.length;c++)this.callbacks[c](a,b);var d=this.callbacks.get(a);if(d&&d.length>0)for(var c=0;c<d.length;c++)d[c].func.call(d[c].ctx||window,b);else this.ft&&this.ft(a,b);return this},Channel.prototype={constructor:Channel,subscribe:function(){this.subscribed=!0,this.client.sendEvent("client:subscribe",{channel:this.name})},unsubscribe:function(){this.subscribed=!1,this.client.sendEvent("client:unsubscribe",{channel:this.name})}},Channels.prototype={constructor:Channels,add:function(a,b){return this.channels[a]||(this.channels[a]=new Channel(a,b)),this.channels[a]},remove:function(a){var b=this.channels[a];return delete this.channels[a],b}},Client.prototype={constructor:Client,subscribe:function(a){var b=this.channels.add(a,this);return"connected"==this.connection.connectionStatus?b.subscribe():setTimeout(function(){b.subscribe()},1e3),b},unsubscribe:function(a){var b=this.channels.remove(a);"connected"==this.connection.connectionStatus&&b.unsubscribe()},sendEvent:function(a,b,c){return this.connection.sendEvent(a,b,c)}},ConnectionManager.prototype={constructor:ConnectionManager,limits:{time:5e3,bound:5},connect:function(a,b){var c=this,d="ws://"+a+":"+b;try{this.connectionStatus="connecting",this.socket=new WebSocket(d),this.socket.onopen=function(){c.connectionStatus="connected",console.log("Socket opened. Session ID: "+c.sessionID),c.tries=0},this.socket.onmessage=function(a){a=a.data;var b=JSON.parse(a),d=b.event,e=b.data;c.emit(d,e)},this.socket.onclose=function(){c.connectionStatus="closed",console.log("Connection closed by host."),console.log("Retrying in "+c.limits.time/1e3+" seconds."),c.tries<c.limits.bound?(c.tries++,console.log("Attempt "+c.tries+" - Retrying..."),c.retryConnection()):console.log("Max retries reached.")},this.socket.onerror=function(){console.error("Unidentified WebSocket error.")}}catch(e){console.log("Unexpected WebSocket error."+e)}},retryConnection:function(){var a=this;setTimeout(function(){a.connect(a.host,a.port)},a.limits.time)},getConnectionState:function(){return this.connectionStatus},sendEvent:function(a,b,c){var d={event:a,data:b};return c&&(d.channel=c),this.send(Util.encodeMessage(d))},send:function(a){return"connected"==this.connectionStatus?(this.socket.send(a),!0):!1}};var Util={};Util.encodeMessage=function(a){return JSON.stringify(a)};